# Drone Communication System: Initialization Process
Version: 1.0.0  
Last Updated: 2024

## Table of Contents
1. [Overview](#overview)
2. [Connection States](#connection-states)
3. [Packet Specifications](#packet-specifications)
4. [Connection Process](#connection-process)
5. [Address Assignment](#address-assignment)
6. [Security Considerations](#security-considerations)

## Overview

The initialization process establishes secure connections between the Ground Control Unit (GCU) and multiple Air Control Units (ACUs). The process follows a DHCP-like discovery and handshake protocol, operating over monitor mode WiFi connections.

### Key Features
- Multiple drone support
- Automatic discovery
- Three-way handshake
- Unique address assignment
- Connection state verification

## Connection States

```mermaid
stateDiagram-v2
    [*] --> DISCONNECTED
    DISCONNECTED --> DISCOVERY: Start Beacon
    DISCOVERY --> REQUESTING: GCU Found
    REQUESTING --> CONNECTING: Address Assigned
    CONNECTING --> CONNECTED: Handshake Complete
    CONNECTED --> ACTIVE: Begin Normal Operation
    
    DISCOVERY --> DISCONNECTED: Timeout
    REQUESTING --> DISCONNECTED: Request Failed
    CONNECTING --> DISCONNECTED: Handshake Failed
    
    ACTIVE --> DISCONNECTED: Connection Lost
```

## Packet Specifications

### Discovery Packet (BEACON)
```mermaid
graph LR
    H[Header<br>BEACON] --> I[Drone ID<br>16 bytes]
    I --> C[Capabilities<br>4 bytes]
    C --> V[Version<br>2 bytes]
    V --> S[Signal Strength<br>1 byte]
    S --> CH[Checksum<br>4 bytes]
```

### Connection Request (SYN)
```mermaid
graph LR
    H[Header<br>SYN] --> I[Drone ID<br>16 bytes]
    I --> R[Request Token<br>8 bytes]
    R --> P[Preferred Channel<br>1 byte]
    P --> CH[Checksum<br>4 bytes]
```

### Address Assignment (ACK)
```mermaid
graph LR
    H[Header<br>ACK] --> I[Drone ID<br>16 bytes]
    I --> A[Assigned Address<br>4 bytes]
    A --> T[Token<br>8 bytes]
    T --> C[Channel<br>1 byte]
    C --> CH[Checksum<br>4 bytes]
```

### Connection Confirmation (SYNACK)
```mermaid
graph LR
    H[Header<br>SYNACK] --> I[Drone ID<br>16 bytes]
    I --> A[Address<br>4 bytes]
    A --> T[Token<br>8 bytes]
    T --> CH[Checksum<br>4 bytes]
```

## Connection Process

### Complete Handshake Sequence

```mermaid
sequenceDiagram
    participant D as Drone (ACU)
    participant G as Ground Station (GCU)
    
    Note over D,G: Discovery Phase
    loop Every 1s until response
        D->>G: BEACON (Drone ID, Capabilities)
    end
    
    Note over D,G: Connection Request
    D->>G: SYN (Drone ID, Request Token)
    G-->>G: Validate Drone ID
    G->>D: ACK (Address Assignment, Token)
    
    Note over D,G: Connection Confirmation
    D-->>D: Configure Network
    D->>G: SYNACK (Address, Token)
    
    Note over D,G: Connection Established
    G->>D: Begin Normal Communication
```

## Address Assignment

### Address Space
- Network ID: 172.16.0.0/16 (Drone Network)
- Available Hosts: 65,534
- Reserved Addresses:
  - 172.16.0.1: Ground Station
  - 172.16.0.2-172.16.255.254: Drone Pool
  - 172.16.255.255: Broadcast

### Assignment Process

```mermaid
graph TD
    A[New Drone Request] --> B{Address Pool Check}
    B -->|Available| C[Select Next Available]
    B -->|Full| D[Reject Connection]
    C --> E{Validate Address}
    E -->|Unused| F[Assign Address]
    E -->|Conflict| G[Select Different Address]
    G --> E
    F --> H[Send ACK]
```

## Security Considerations

### Token Generation
1. **Request Token**
   - 64-bit random value
   - Generated by drone
   - Used for initial request

2. **Session Token**
   - 64-bit random value
   - Generated by ground station
   - Used for ongoing communication

### Validation Process
1. **Beacon Phase**
   - Verify drone ID against whitelist
   - Check firmware version
   - Validate capabilities

2. **Connection Phase**
   - Validate all checksums
   - Verify token matches
   - Confirm address assignment

### Security Measures
```mermaid
graph TD
    A[Security Measures] --> B[Token Validation]
    A --> C[Checksum Verification]
    A --> D[ID Whitelist]
    A --> E[Version Check]
    
    B --> F[Session Management]
    C --> G[Data Integrity]
    D --> H[Access Control]
    E --> I[Compatibility]
```

## Implementation Notes

### Ground Station Requirements
1. **Connection Manager**
   - Track active connections
   - Manage address pool
   - Handle multiple simultaneous requests

2. **Monitor Mode Configuration**
   - Channel hopping for discovery
   - Signal strength monitoring
   - Interference detection

3. **Connection States**
   - Track each drone's state
   - Handle timeout conditions
   - Manage reconnection attempts

### Drone Requirements
1. **Beacon Mode**
   - Configurable beacon interval
   - Signal strength monitoring
   - Channel scanning

2. **Connection Handler**
   - Process address assignment
   - Validate tokens
   - Configure network interface

3. **State Management**
   - Track connection state
   - Handle timeout conditions
   - Manage reconnection attempts 